# The patch_generator utility

## In short

Python framework that allows you to train and predict using Keras neural network. Adapted to patches generated by:

https://github.com/sdrdis/patch_generator

## How to install

You must have installed python 3.6 and pip.

1. Download the framework by cloning this github project or by clicking here
2. Install dependencies writen in the `requirement.txt` file manually or by running `pip install -r requirements.txt` in the shell.

## General process

The nn utility allows to train a neural network to predict semantic segmentation maps. It is comprised of 2 scripts:

- `train.py`: allows to train a neural network on patches generated by the patch_generator utility
- `predict.py`: allows to predict a semantic segmentation on an image.

All utilities need a python configuration file to run.

### The configuration file structure

Configuration files are generally placed in the configs/ folder. It needs to define several variables:

- `generator`: the module containing the DataGenerator class that inherits from keras.utils.Sequence. Defines how to load patches and feed them to the neural network.
- `path`: path of patches generated by the patch_generator utility.
- `input_shape`: the input patch shape.
- `output_shape`: the expected shape of the output.
- `batch_size`: the batch size to feed the network.
- `get_model`: a method that returns a Keras model (the deep neural network).
- `image_preprocessing`: method that takes the image as input and returns the processed image as output. This processing is done on the prediction scripts, before the image is cut into different patches.
- `process_patch`: how to process a patch before feeding it on the neural network (done for training and prediction).


### The train.py script

This script trains a neural network on the patches generator by patch_generator.

Parameters:

- `config_filepath`: the configuration file path formatted as a python module. For instance, if configuration file is located at configs/config.py then its value would be configs.config.
- `from_model`: (optional) the path to the preexisting model to learn from.

When training, at each epoch, if the model beats the previous one on the validation batch, it is saved at `models/CONFIG/NUM.h5`, `CONFIG` being the configuration filename, and `NUM` being the first available number.

### The predict.py script

This script predicts a semantic segmentation map from an image.

Parameters:
- `config`: the configuration path (see train.py).
- `model`: the path of the model.
- `input`: the image input
- `output`: the output semantic segmentation map in the npz format. There are two keys: im_np, the image, and pred_np, the prediction matrix. The prediction matrix size is (width, height, nb classes).
- `debug`: for debugging purposes, saves segmentation map in image format in the `tmp` folder.
